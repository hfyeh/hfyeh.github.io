<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>OpenWRT Config Generation - sharefun</title>
<meta name=description content="In OpenWRT, all config files under /etc/config are generated dynamically. There are scripts in /etc/uci-defaults to construct this configuration.
The scripts in /etc/uci-defaults are executed on first boot and then removed."><meta name=author content><link rel="preload stylesheet" href=https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.css><script src=https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js></script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script>MathJax={tex:{inlineMath:[["$","$"]],displayMath:[["$$","$$"]]}}</script><script id=MathJax-script defer src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link rel="preload stylesheet" href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/styles/gruvbox-dark.min.css><script defer src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/highlight.min.js onload=hljs.initHighlightingOnLoad()></script><link rel=icon type=image/x-icon href=https://hfyeh.github.io/images/favicon.ico><link rel=apple-touch-icon href=https://hfyeh.github.io/images/apple-touch-icon-dark.png><link rel=stylesheet href=https://hfyeh.github.io/stylesheets/dark.css><link rel="preload stylesheet" as=style href=https://hfyeh.github.io/custom.min.css><meta name=generator content="Hugo 0.123.1"><meta property="og:title" content="OpenWRT Config Generation"><meta property="og:description" content="In OpenWRT, all config files under /etc/config are generated dynamically. There are scripts in /etc/uci-defaults to construct this configuration.
The scripts in /etc/uci-defaults are executed on first boot and then removed."><meta property="og:type" content="article"><meta property="og:url" content="https://hfyeh.github.io/posts/openwrt-config-generation/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-02-22T00:00:00+00:00"><meta property="article:modified_time" content="2024-02-22T00:00:00+00:00"><meta itemprop=name content="OpenWRT Config Generation"><meta itemprop=description content="In OpenWRT, all config files under /etc/config are generated dynamically. There are scripts in /etc/uci-defaults to construct this configuration.
The scripts in /etc/uci-defaults are executed on first boot and then removed."><meta itemprop=datePublished content="2024-02-22T00:00:00+00:00"><meta itemprop=dateModified content="2024-02-22T00:00:00+00:00"><meta itemprop=wordCount content="206"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="OpenWRT Config Generation"><meta name=twitter:description content="In OpenWRT, all config files under /etc/config are generated dynamically. There are scripts in /etc/uci-defaults to construct this configuration.
The scripts in /etc/uci-defaults are executed on first boot and then removed."><meta name=twitter:site content="@SharefunYeh"></head><body><div class="grid grid-centered"><div class=grid-cell><nav class="header-nav scrollappear"><a href=/ class=header-logo title=sharefun>sharefun</a><ul class=header-links><li><a href=https://www.facebook.com/sharefun010407 rel="noreferrer noopener" target=_blank title=Facebook><svg xmlns="http://www.w3.org/2000/svg" class="icon-facebook"><use href="https://hfyeh.github.io/icons/facebook.svg#icon-facebook" xlink:href="https://hfyeh.github.io/icons/facebook.svg#icon-facebook"/></svg></a></li><li><a href=https://github.com/hfyeh rel="noreferrer noopener" target=_blank title=GitHub><svg xmlns="http://www.w3.org/2000/svg" class="icon-github"><use href="https://hfyeh.github.io/icons/github.svg#icon-github" xlink:href="https://hfyeh.github.io/icons/github.svg#icon-github"/></svg></a></li><li><a href=https://twitter.com/SharefunYeh rel="noreferrer noopener" target=_blank title=Twitter><svg xmlns="http://www.w3.org/2000/svg" class="icon-twitter"><use href="https://hfyeh.github.io/icons/twitter.svg#icon-twitter" xlink:href="https://hfyeh.github.io/icons/twitter.svg#icon-twitter"/></svg></a></li></ul></nav><article class="article scrollappear"><header class=article-header><h1>OpenWRT Config Generation</h1></header><div class=article-list-header><span class=article-list-date>February 22, 2024</span></div><div class=article-content><p>In OpenWRT, all config files under <code>/etc/config</code> are generated dynamically. There are scripts in <code>/etc/uci-defaults</code> to construct this configuration.</p><p>The scripts in <code>/etc/uci-defaults</code> are executed on first boot and then removed.</p><p>Although the scripts are removed on first boot, we could still find them in the image. For example, if you&rsquo;re using an imagebuilder to build the image, once you built, under imagebuilder root, <code>build_dir/target-aarch64_cortex-a72_musl/root-bcm27xx/</code> are the rootfs of bcm27xx targets, and the sub-directory <code>/etc/uci-defaults</code> is what we are looking for.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>10_migrate-shadow        14_migrate-dhcp-release  50-dnsmasq-migrate-resolv-conf-auto.sh
</span></span><span style=display:flex><span>12_network-generate-ula  15_odhcpd                90-resize-filesystem-to-partition-size
</span></span><span style=display:flex><span>13_fix-group-user        20_migrate-feeds         99-override-network-proto-lan-to-dhcp
</span></span></code></pre></div><p>The content of <code>12_network-generate-ula</code> is</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>uci -q get network.globals.ula_prefix<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span> !<span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;auto&#34;</span> <span style=color:#f92672>]</span> <span style=color:#f92672>&amp;&amp;</span> exit <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>r1<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>dd <span style=color:#66d9ef>if</span><span style=color:#f92672>=</span>/dev/urandom bs<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> count<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> |hexdump -e <span style=color:#e6db74>&#39;1/1 &#34;%02x&#34;&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>r2<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>dd <span style=color:#66d9ef>if</span><span style=color:#f92672>=</span>/dev/urandom bs<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> count<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> |hexdump -e <span style=color:#e6db74>&#39;2/1 &#34;%02x&#34;&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>r3<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>dd <span style=color:#66d9ef>if</span><span style=color:#f92672>=</span>/dev/urandom bs<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> count<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> |hexdump -e <span style=color:#e6db74>&#39;2/1 &#34;%02x&#34;&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>uci -q batch <span style=color:#e6db74>&lt;&lt;-EOF &gt;/dev/null
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        set network.globals.ula_prefix=fd$r1:$r2:$r3::/48
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        commit network
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>exit <span style=color:#ae81ff>0</span>
</span></span></code></pre></div><p>If we want to change this default configuration, just add another uci-defaults script with larger number in the filename, i.e. <code>00_customize_network_setting</code>.</p><p>Sometimes we want to use built-in scripts to save our time of writing the script using raw UCI commands. There are functions in <code>build_dir/target-aarch64_cortex-a72_musl/root-bcm27xx/lib/functions/</code> to provide such functionality. For example, there is <code>network.sh</code> which defines some functions to make the scripting more easily.</p></div><div class=article-list-footer><div class=article-list-tags></div></div></article><footer class="footer scrollappear"><p><span>&copy; 2024 <a href=https://hfyeh.github.io/>sharefun</a></span>
<span>Powered by <a href=https://gohugo.io/ rel=noopener target=_blank>Hugo</a></span>
<span>Theme is based on <a href=https://github.com/nielsenramon/chalk rel="noreferrer noopener" target=_blank>Chalk</a></span></p></footer><script>var config={startOnLoad:!0,theme:"forest",classDiagram:{useMaxWidth:!1,htmlLabels:!0}};mermaid.initialize(config),window.mermaid.init(void 0,document.querySelectorAll(".language-mermaid"))</script><style>.language-mermaid>svg{background-color:#e8e8e8}</style></div></div></main><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js></script><script src=https://hfyeh.github.io/javascripts/zooming.min.js></script><script src=https://hfyeh.github.io/javascripts/retina.min.js></script><script src=https://hfyeh.github.io/javascripts/svgxuse.min.js></script><script src=https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js></script><script src=https://hfyeh.github.io/javascripts/vendor.min.js></script><script src=https://hfyeh.github.io/javascripts/webfonts.min.js></script><script src=https://hfyeh.github.io/javascripts/scrollappear.min.js></script><script src=https://hfyeh.github.io/javascripts/application.min.js></script></body></html>